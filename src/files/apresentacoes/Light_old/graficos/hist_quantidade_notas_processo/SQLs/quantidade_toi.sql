select 'toi', count(distinct(case when extract(year from notas_ren.data_de_criacao_da_nota) = 2009 then contratos.id else NULL end)) as toi_2009, count(distinct(case when extract(year from notas_ren.data_de_criacao_da_nota) = 2010 then contratos.id else NULL end)) as toi_2010, count(distinct(case when extract(year from notas_ren.data_de_criacao_da_nota) = 2011 then contratos.id else NULL end)) as toi_2011 from notas_ren inner join contratos on notas_ren.instalacao = contratos.instalacao and contratos.data_inicio <= notas_ren.data_de_criacao_da_nota and contratos.data_fim >= notas_ren.data_do_encerramento_da_nota inner join negociacoes_ren on negociacoes_ren.notas = notas_ren.id;
